
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>openvpn基本搭建实例 - Linux SA Notes By 枯木</title>
  <meta name="author" content="枯木">

  
  <meta name="description" content="OpenVPN是一个用于创建虚拟专用网络加密通道的软件包，最早由James Yonan编写。OpenVPN允许创建的VPN使用公开密钥、电子证书、或者用户名／密码来进行身份验证。 准备软件： 本例以RHEL6.3为例 openvpn-2.3.1
lzo-2.06
[最新版本的openvpn-2.3 &hellip;">
  <meta name="keywords" content="openvpn,Linux">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kumu-Linux.github.com/blog/2013/05/23/openvpn">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Linux SA Notes By 枯木" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39949989-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Linux SA Notes By 枯木</a></h1>
  
    <h2>Linux、Python、MySQL -- 像黑客一样写作</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com.hk/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kumu-Linux.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">关于我</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Openvpn基本搭建实例</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-23T10:19:00+08:00" pubdate data-updated="true">May 23<span>rd</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>OpenVPN是一个用于创建虚拟专用网络加密通道的软件包，最早由James Yonan编写。OpenVPN允许创建的VPN使用公开密钥、电子证书、或者用户名／密码来进行身份验证。</p>

<!--more-->




<center><img src="/images/openvpn.png" alt="openvpn" title="openvpn" width="500" /></center>


<h2>准备软件：</h2>

<p>本例以RHEL6.3为例</p>

<ul>
<li><a href="http://swupdate.openvpn.org/community/releases/openvpn-2.3.1.tar.gz">openvpn-2.3.1</a></li>
<li><a href="http://www.oberhumer.com/opensource/lzo/download/lzo-2.06.tar.gz">lzo-2.06</a></li>
<li>[最新版本的openvpn-2.3.1官方不再集成<code>easy-rsa</code>] Note that easy-rsa is no longer bundled with OpenVPN source code archives. To get it, visit the easy-rsa page on GitHub, or download it from our Linux software repositories.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/OpenVPN/easy-rsa
</span></code></pre></td></tr></table></div></figure>


<h2>软件安装</h2>

<p><code>openssl</code>、<code>openssl-devel</code>、<code>pam</code>、<code>pam-devel</code>安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install openssl openssl-devel pam pam-devel -y
</span></code></pre></td></tr></table></div></figure>


<p><code>lzo-2.06</code>安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
</span></code></pre></td></tr></table></div></figure>


<p><code>openvpn-2.3.1</code>安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install
</span></code></pre></td></tr></table></div></figure>


<h2>相关配置</h2>

<h3>添加环境变量</h3>

<p>在<code>~/.barc_profile</code>文件中加入如下内容,命名根据实际需求修改：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">D</span><span class="o">=</span>/etc/openvpn
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_CONFIG</span><span class="o">=</span><span class="nv">$D</span>/openssl.cnf
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_DIR</span><span class="o">=</span><span class="nv">$D</span>/keys
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_SIZE</span><span class="o">=</span>1024
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_COUNTRY</span><span class="o">=</span>CN
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_PROVINCE</span><span class="o">=</span>BJ
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_CITY</span><span class="o">=</span>BJ
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_ORG</span><span class="o">=</span>kumu
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_OU</span><span class="o">=</span>kumu
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_NAME</span><span class="o">=</span>kumu
</span><span class='line'><span class="nb">export </span><span class="nv">KEY_EMAIL</span><span class="o">=</span>root@kumu
</span></code></pre></td></tr></table></div></figure>


<p>使新增环境变量生效并新建配置文件目录<code>/etc/openvpn</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># source ~/.barc_profile</span>
</span><span class='line'><span class="c"># mkdir /etc/openvpn</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注</strong>:也可修改easy-rsa中的vars【/usr/local/src/openvpn/easy-rsa/easy-rsa/2.0/vars】，source生效</p>

<h3>生成密钥</h3>

<p>进入之前下载的<code>easy-rsa</code>目录</p>

<p><strong>初始化PKI、生成证书</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># pwd</span>
</span><span class='line'>/usr/local/src/openvpn/easy-rsa/easy-rsa/2.0
</span><span class='line'><span class="c"># ls</span>
</span><span class='line'>build-ca     build-key         build-key-server  clean-all      openssl-0.9.6.cnf  pkitool      vars
</span><span class='line'>build-dh     build-key-pass    build-req         inherit-inter  openssl-0.9.8.cnf  revoke-full  whichopensslcnf
</span><span class='line'>build-inter  build-key-pkcs12  build-req-pass    list-crl       openssl-1.0.0.cnf  sign-req
</span><span class='line'><span class="c"># cp openssl-1.0.0.cnf /etc/openvpn/openssl.cnf</span>
</span><span class='line'><span class="c"># ./clean-all #初始化，清除原有不需要的文件</span>
</span><span class='line'><span class="c"># ./build-ca  #一直回车即可</span>
</span><span class='line'>Generating a 1024 bit RSA private key
</span><span class='line'>.......++++++
</span><span class='line'>............++++++
</span><span class='line'>writing new private key to <span class="s1">&#39;ca.key&#39;</span>
</span><span class='line'>-----
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>CN<span class="o">]</span>:
</span><span class='line'>State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>BJ<span class="o">]</span>:
</span><span class='line'>Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>BJ<span class="o">]</span>:
</span><span class='line'>Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>kumu<span class="o">]</span>:
</span><span class='line'>Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>kumu<span class="o">]</span>:
</span><span class='line'>Common Name <span class="o">(</span>eg, your name or your server<span class="err">&#39;</span>s hostname<span class="o">)</span> <span class="o">[</span>kumu CA<span class="o">]</span>:
</span><span class='line'>Name <span class="o">[]</span>:kumu
</span><span class='line'>Email Address <span class="o">[</span>root@kumu<span class="o">]</span>:
</span></code></pre></td></tr></table></div></figure>


<p><strong>生成Server端证书Server Key</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ./build-key-server kumu_server #一路回车，密码处填写密码</span>
</span><span class='line'>Generating a 1024 bit RSA private key
</span><span class='line'>....................................++++++
</span><span class='line'>.........++++++
</span><span class='line'>writing new private key to <span class="s1">&#39;kumu_server.key&#39;</span>
</span><span class='line'>-----
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>CN<span class="o">]</span>:
</span><span class='line'>State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>BJ<span class="o">]</span>:
</span><span class='line'>Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>BJ<span class="o">]</span>:
</span><span class='line'>Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>kumu<span class="o">]</span>:
</span><span class='line'>Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>kumu<span class="o">]</span>:
</span><span class='line'>Common Name <span class="o">(</span>eg, your name or your server<span class="s1">&#39;s hostname) [kumu_server]:</span>
</span><span class='line'><span class="s1">Name [kumu]:</span>
</span><span class='line'><span class="s1">Email Address [root@kumu]:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Please enter the following &#39;</span>extra<span class="s1">&#39; attributes</span>
</span><span class='line'><span class="s1">to be sent with your certificate request</span>
</span><span class='line'><span class="s1">A challenge password []:123321  #输入密码</span>
</span><span class='line'><span class="s1">An optional company name []:kumu</span>
</span><span class='line'><span class="s1">Using configuration from /etc/openvpn/openssl.cnf</span>
</span><span class='line'><span class="s1">Check that the request matches the signature</span>
</span><span class='line'><span class="s1">Signature ok</span>
</span><span class='line'><span class="s1">The Subject&#39;</span>s Distinguished Name is as follows
</span><span class='line'>countryName           :PRINTABLE:<span class="s1">&#39;CN&#39;</span>
</span><span class='line'>stateOrProvinceName   :PRINTABLE:<span class="s1">&#39;BJ&#39;</span>
</span><span class='line'>localityName          :PRINTABLE:<span class="s1">&#39;BJ&#39;</span>
</span><span class='line'>organizationName      :PRINTABLE:<span class="s1">&#39;kumu&#39;</span>
</span><span class='line'>organizationalUnitName:PRINTABLE:<span class="s1">&#39;kumu&#39;</span>
</span><span class='line'>commonName            :T61STRING:<span class="s1">&#39;kumu_server&#39;</span>
</span><span class='line'>name                  :PRINTABLE:<span class="s1">&#39;kumu&#39;</span>
</span><span class='line'>emailAddress          :IA5STRING:<span class="s1">&#39;root@kumu&#39;</span>
</span><span class='line'>Certificate is to be certified <span class="k">until </span>May 11 22:54:08 2023 GMT <span class="o">(</span>3650 days<span class="o">)</span>
</span><span class='line'>Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>1 out of 1 certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span><span class='line'>Write out database with 1 new entries
</span><span class='line'>Data Base Updated
</span></code></pre></td></tr></table></div></figure>


<p><strong>生成Client端证书</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ./build-key kumu_client1  #一路回车，密码处填写密码</span>
</span><span class='line'>Generating a 1024 bit RSA private key
</span><span class='line'>..++++++
</span><span class='line'>.....................++++++
</span><span class='line'>writing new private key to <span class="s1">&#39;kumu_client1.key&#39;</span>
</span><span class='line'>-----
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter <span class="s1">&#39;.&#39;</span>, the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>CN<span class="o">]</span>:
</span><span class='line'>State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>BJ<span class="o">]</span>:
</span><span class='line'>Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>BJ<span class="o">]</span>:
</span><span class='line'>Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>kumu<span class="o">]</span>:
</span><span class='line'>Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>kumu<span class="o">]</span>:
</span><span class='line'>Common Name <span class="o">(</span>eg, your name or your server<span class="s1">&#39;s hostname) [kumu_client1]:</span>
</span><span class='line'><span class="s1">Name [kumu]:</span>
</span><span class='line'><span class="s1">Email Address [root@kumu]:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Please enter the following &#39;</span>extra<span class="s1">&#39; attributes</span>
</span><span class='line'><span class="s1">to be sent with your certificate request</span>
</span><span class='line'><span class="s1">A challenge password []:123321</span>
</span><span class='line'><span class="s1">An optional company name []:kumu</span>
</span><span class='line'><span class="s1">Using configuration from /etc/openvpn/openssl.cnf</span>
</span><span class='line'><span class="s1">Check that the request matches the signature</span>
</span><span class='line'><span class="s1">Signature ok</span>
</span><span class='line'><span class="s1">The Subject&#39;</span>s Distinguished Name is as follows
</span><span class='line'>countryName           :PRINTABLE:<span class="s1">&#39;CN&#39;</span>
</span><span class='line'>stateOrProvinceName   :PRINTABLE:<span class="s1">&#39;BJ&#39;</span>
</span><span class='line'>localityName          :PRINTABLE:<span class="s1">&#39;BJ&#39;</span>
</span><span class='line'>organizationName      :PRINTABLE:<span class="s1">&#39;kumu&#39;</span>
</span><span class='line'>organizationalUnitName:PRINTABLE:<span class="s1">&#39;kumu&#39;</span>
</span><span class='line'>commonName            :T61STRING:<span class="s1">&#39;kumu_client1&#39;</span>
</span><span class='line'>name                  :PRINTABLE:<span class="s1">&#39;kumu&#39;</span>
</span><span class='line'>emailAddress          :IA5STRING:<span class="s1">&#39;root@kumu&#39;</span>
</span><span class='line'>Certificate is to be certified <span class="k">until </span>May 11 23:01:12 2023 GMT <span class="o">(</span>3650 days<span class="o">)</span>
</span><span class='line'>Sign the certificate? <span class="o">[</span>y/n<span class="o">]</span>:y
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>1 out of 1 certificate requests certified, commit? <span class="o">[</span>y/n<span class="o">]</span>y
</span><span class='line'>Write out database with 1 new entries
</span><span class='line'>Data Base Updated
</span><span class='line'><span class="c"># ls /etc/openvpn/keys/</span>
</span><span class='line'>01.pem  ca.key      index.txt.attr      kumu_client1.crt  kumu_server.crt  openvpn-status.log
</span><span class='line'>02.pem  dh1024.pem  index.txt.attr.old  kumu_client1.csr  kumu_server.csr  serial
</span><span class='line'>ca.crt  index.txt   index.txt.old       kumu_client1.key  kumu_server.key  serial.old
</span></code></pre></td></tr></table></div></figure>


<p><strong>注</strong>：生成其他客户端证书以此类推，名字不相同即可</p>

<p><strong>证书加密</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ./build-dh </span>
</span><span class='line'>./build-dh: line 7: dhparam: <span class="nb">command </span>not found
</span></code></pre></td></tr></table></div></figure>


<p>出现如上问题，修改<code>./build-dh</code>命令中<code>$OPENSSL</code>为<code>openssl</code>即可，原因是默认<code>/usr/local/src/openvpn/easy-rsa/easy-rsa/2.0/vars</code>文件定义了<code>OPENSSL=openssl</code>,而笔者没有引用<code>vars</code>文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ./build-dh </span>
</span><span class='line'>Generating DH parameters, 1024 bit long safe prime, generator 2
</span><span class='line'>This is going to take a long <span class="nb">time</span>
</span><span class='line'>... ...
</span><span class='line'><span class="c"># openvpn --genkey --secret /etc/openvpn/keys/ta.key  #生成加密key</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Server端配置文件修改:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># pwd</span>
</span><span class='line'>/usr/local/src/openvpn/openvpn-2.3.1/sample/sample-config-files
</span><span class='line'><span class="c"># ls </span>
</span><span class='line'>client.conf  loopback-client  openvpn-shutdown.sh  server.conf         tls-home.conf         xinetd-server-config
</span><span class='line'>firewall.sh  loopback-server  openvpn-startup.sh   static-home.conf    tls-office.conf
</span><span class='line'>home.up      office.up        README               static-office.conf  xinetd-client-config
</span><span class='line'><span class="c"># cp server.conf /etc/openvpn/  #拷贝Server模板配置文件到配置目录</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Server端配置文件内容如下</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># grep -vE &#39;^;|^$|^#&#39; /etc/openvpn/server.conf </span>
</span><span class='line'>port 1194
</span><span class='line'>proto udp
</span><span class='line'>dev tun
</span><span class='line'>ca /etc/openvpn/keys/ca.crt
</span><span class='line'>cert /etc/openvpn/keys/kumu_server.crt
</span><span class='line'>key /etc/openvpn/keys/kumu_server.key  <span class="c"># This file should be kept secret</span>
</span><span class='line'>dh /etc/openvpn/keys/dh1024.pem
</span><span class='line'>server 10.8.0.0 255.255.255.0
</span><span class='line'>push <span class="s2">&quot;route 192.168.10.0 255.255.255.0&quot;</span> <span class="c"># 推送路由</span>
</span><span class='line'>client-to-client
</span><span class='line'>keepalive 10 120
</span><span class='line'>tls-auth /etc/openvpn/keys/ta.key 0 <span class="c"># This file is secret</span>
</span><span class='line'>comp-lzo
</span><span class='line'>persist-key
</span><span class='line'>persist-tun
</span><span class='line'>status /etc/openvpn/keys/openvpn-status.log
</span><span class='line'>verb 3
</span></code></pre></td></tr></table></div></figure>


<h3>开启路由转发和启动Openvpn</h3>

<p><strong>开启路由转发</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo </span>1 &gt; /proc/sys/net/ipv4/ip_forward <span class="c">#临时开启</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者修改/etc/sysctl.conf中<code>net.ipv4.ip_forward = 1</code>，执行<code>sysctl -p</code>永久生效</p>

<p><strong>启动服务</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openvpn --config /etc/openvpn/server.conf --daemon
</span></code></pre></td></tr></table></div></figure>


<h3>Windows客户端连接配置</h3>

<ul>
<li>64位安装<a href="http://swupdate.openvpn.org/community/releases/openvpn-install-2.3.1-I001-x86_64.exe">openvpn-2.3.1-X86_64.exe</a></li>
<li>32位请安装<a href="http://swupdate.openvpn.org/community/releases/openvpn-install-2.3.1-I001-i686.exe">openvpn-2.3.1-i686.exe</a></li>
</ul>


<p>拷贝Server端生成的如下客户端证书到Windows软件安装目录<code>OpenVPN\config</code>下</p>

<ul>
<li>kumu_client1.crt</li>
<li>kumu_client1.key</li>
<li>ca.key</li>
<li>ta.key</li>
</ul>


<p>在<code>OpenVPN\config</code>目录中新建Client端配置文件<code>client.ovpn</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>client
</span><span class='line'>dev tun
</span><span class='line'>proto udp
</span><span class='line'>remote 10.2.0.110 1194
</span><span class='line'>resolv-retry infinite
</span><span class='line'>nobind
</span><span class='line'>persist-key
</span><span class='line'>persist-tun
</span><span class='line'>ca ca.crt
</span><span class='line'>cert kumu_client1.crt
</span><span class='line'>key kumu_client1.key
</span><span class='line'>ns-cert-type server
</span><span class='line'>tls-auth ta.key 1
</span><span class='line'>comp-lzo
</span><span class='line'>verb 3
</span></code></pre></td></tr></table></div></figure>


<p>Win7/Win8以管理员身份启动Openvpn Windows客户端即可，基本的Windows安装这里不作介绍，如果正常，Openvpn Gui客户端显示绿色，ping测试无误，如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>C:<span class="se">\U</span>sers<span class="se">\k</span>umu&gt;ping 10.8.0.1  <span class="c">#测试VPN</span>
</span><span class='line'>
</span><span class='line'>正在 Ping 10.8.0.1 具有 32 字节的数据:
</span><span class='line'>来自 10.8.0.1 的回复: 字节<span class="o">=</span>32 时间&lt;1ms <span class="nv">TTL</span><span class="o">=</span>64
</span><span class='line'>来自 10.8.0.1 的回复: 字节<span class="o">=</span>32 时间&lt;1ms <span class="nv">TTL</span><span class="o">=</span>64
</span><span class='line'>... ...
</span><span class='line'>C:<span class="se">\U</span>sers<span class="se">\k</span>umu&gt;ping 192.168.10.19 <span class="c">#测试内网</span>
</span><span class='line'>
</span><span class='line'>正在 Ping 192.168.10.19 具有 32 字节的数据:
</span><span class='line'>来自 192.168.10.19 的回复: 字节<span class="o">=</span>32 时间<span class="o">=</span>1ms <span class="nv">TTL</span><span class="o">=</span>64
</span><span class='line'>来自 192.168.10.19 的回复: 字节<span class="o">=</span>32 时间<span class="o">=</span>2ms <span class="nv">TTL</span><span class="o">=</span>64
</span><span class='line'>... ...
</span></code></pre></td></tr></table></div></figure>


<h3>Linux客户端配置</h3>

<p><strong>安装</strong>参见Server端安装</p>

<h4>相关配置</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># mkdir /etc/openvpn</span>
</span><span class='line'><span class="c"># cp /usr/local/src/openvpn/openvpn-2.3.1/sample/sample-config-files/client.conf /etc/openvpn/</span>
</span><span class='line'><span class="c"># grep -vE &#39;^$|^#|^;&#39; /etc/openvpn/client.conf</span>
</span><span class='line'>client
</span><span class='line'>dev tun
</span><span class='line'>proto udp
</span><span class='line'>remote 10.2.0.110 1194
</span><span class='line'>resolv-retry infinite
</span><span class='line'>nobind
</span><span class='line'>persist-key
</span><span class='line'>persist-tun
</span><span class='line'>ca ca.crt
</span><span class='line'>cert kumu_client1.crt
</span><span class='line'>key kumu_client1.key
</span><span class='line'>ns-cert-type server
</span><span class='line'>tls-auth ta.key 1
</span><span class='line'>comp-lzo
</span><span class='line'>verb 3
</span></code></pre></td></tr></table></div></figure>


<p>拷贝Server端生成的如下客户端证书到Linux客户端/etc/openvpn下(这里为了方便不再生成一套客户端证书了)</p>

<ul>
<li>kumu_client1.crt</li>
<li>kumu_client1.key</li>
<li>ca.key</li>
<li>ta.key</li>
</ul>


<p><strong>启动Openvpn客户端服务</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openvpn --config /etc/openvpn/client.conf --daemon
</span></code></pre></td></tr></table></div></figure>


<h4>测试</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ifconfig tun0</span>
</span><span class='line'>tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
</span><span class='line'>          inet addr:10.8.0.6  P-t-P:10.8.0.5  Mask:255.255.255.255
</span><span class='line'>... ...
</span><span class='line'><span class="c"># route -n</span>
</span><span class='line'>Kernel IP routing table
</span><span class='line'>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span><span class='line'>10.8.0.5        0.0.0.0         255.255.255.255 UH    0      0        0 tun0
</span><span class='line'>10.8.0.0        10.8.0.5        255.255.255.0   UG    0      0        0 tun0
</span><span class='line'>192.168.10.0    10.8.0.5        255.255.255.0   UG    0      0        0 tun0
</span><span class='line'>... ...
</span><span class='line'><span class="c"># ping 192.168.10.19</span>
</span><span class='line'>PING 192.168.10.19 <span class="o">(</span>192.168.10.19<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'>64 bytes from 192.168.10.19: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.690 ms
</span><span class='line'>64 bytes from 192.168.10.19: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>1.21 ms
</span><span class='line'>... ...
</span></code></pre></td></tr></table></div></figure>


<p>测试正常，无误！</p>

<p>&#8211;EOF&#8211;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">枯木</span></span>

      








  


<time datetime="2013-05-23T10:19:00+08:00" pubdate data-updated="true">May 23<span>rd</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/unix-slash-linux/'>UNIX/Linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
  <div class="bshare-custom"><a title="分享到QQ空间" class="bshare-qzone"></a><a title="分享到新浪微博" class="bshare-sinaminiblog"></a><a title="分享到人人网" class="bshare-renren"></a><a title="分享到腾讯微博" class="bshare-qqmb"></a><a title="分享到网易微博" class="bshare-neteasemb"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a><span class="BSHARE_COUNT bshare-share-count">0</span></div><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=1&amp;lang=zh"></script><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/05/21/named-chroot/" title="Previous Post: DNS chroot rsyslog配置">&laquo; DNS chroot rsyslog配置</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Sina Weibo</h1>
  <iframe id="sina_widget_1912914742" style="width:100%; height:500px;" frameborder="0" scrolling="no" src="http://v.t.sina.com.cn/widget/widget_blog.php?uid=1912914742&height=500&skin=wd_02&showpic=1">
  </iframe>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/23/openvpn/">openvpn基本搭建实例</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/21/named-chroot/">DNS chroot rsyslog配置</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/20/ntp/">NTP服务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/14/ping-dns/">ping和dns的一个小插曲</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/06/rsync-ssh/">rsync备份之ssh篇</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/05/sed-7/">2-2、Global Flag (g flag)[译]</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="category-list"><li><a href='/blog/categories/octopress/'>Octopress (2)</a></li><li><a href='/blog/categories/sed-slash-awk/'>SED/AWK (7)</a></li><li><a href='/blog/categories/unix-slash-linux/'>UNIX/Linux (7)</a></li><li><a href='/blog/categories/bei-fen-hui-fu/'>备份恢复 (1)</a></li><li><a href='/blog/categories/sheng-huo-sui-xiang/'>生活随想 (2)</a></li><li><a href='/blog/categories/jian-kong-diao-you/'>监控调优 (2)</a></li><li><a href='/blog/categories/yun-wei-li-qi/'>运维利器 (2)</a></li></ul>
</section><section>
  <h1>Cool Links</h1>
  <ul>
    <li>
      <a href="http://coolshell.cn/">【 酷壳 CoolShell 】</a> 
	</li>
	<li>
      <a href="http://dbanotes.net/">【  Fenng 闲思录  】</a>
	</li>
	<li>
      <a href="http://www.ruanyifeng.com/blog/">【阮一峰网络日志】</a>
    </li>
	<li>
	  <a href="http://blog.linuxhonker.com/">【服务器架构研究】</a>
    </li>
	<li>
	<a href="http://blog.csdn.net/kumu_Linux">【 枯木CSDN Blog 】</a>
	</li>
	<li>
	<a href="http://lin-credible.github.io/">【Lin-credible blog】</a>
	</li>
  </ul>
</section><section id="comment_sidebar">
<h1>Recent Conmments</h1>
  <script type="text/javascript" src="http://kumusanotes.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>
</section><section>
<h1>Just Douban</h1>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/39084560/?show=collection&amp;n=8&amp;columns=2" ></script> 
</div>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 枯木 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kumusanotes';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kumu-Linux.github.com/blog/2013/05/23/openvpn/';
        var disqus_url = 'http://kumu-Linux.github.com/blog/2013/05/23/openvpn/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







</body>
</html>
